<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Neighborhood Map</title>
    <link rel="stylesheet" href="css/style.css" type="text/css">
</head>
<body>
    <div class="container">
        <div class="options-box">
            <h1>Find MRT Stations in Singapore</h1>
            <div>
                <input id="txtFilter" type="text" placeholder="Station Name">
                <input id="btnFilter" type="button" value="Filter">
            </div>
            <hr>
            <div>
                <ul data-bind="foreach: stationList">
                    <li data-bind="text: title, click: showInfo($parent)"></li>
                </ul>

                <div data-bind="with: currentStation">
                    <h2 data-bind="text: title"></h2>
                    <div data-bind="text: address"></div>
                </div>
            </div>
            <hr>
        </div>
        <div id="map"></div>
    </div>

    <script src="js/lib/knockout-3.2.0.js"></script>
    <script src="js/app.js"></script>
    <script>
    var map;

    // Create a new blank array for all the listing markers.
    var markers = [];

    // This global polygon variable is to ensure only ONE polygon is rendered.
    var polygon = null;

    // Create placemarkers array to use in multiple functions to have control
    // over the number of places that show.
    var placeMarkers = [];

    function initMap() {
        // Create a styles array to use with the map.
        var styles = [
            {
                featureType: 'water',
                stylers: [
                    { color: '#19a0d8' }
                ]
            },{
                featureType: 'administrative',
                elementType: 'labels.text.stroke',
                stylers: [
                    { color: '#ffffff' },
                    { weight: 6 }
                ]
            },{
                featureType: 'administrative',
                elementType: 'labels.text.fill',
                stylers: [
                    { color: '#e85113' }
                ]
            },{
                featureType: 'road.highway',
                elementType: 'geometry.stroke',
                stylers: [
                    { color: '#efe9e4' },
                    { lightness: -40 }
                ]
            },{
                featureType: 'transit.station',
                stylers: [
                    { weight: 9 },
                    { hue: '#e85113' }
                ]
            },{
                featureType: 'road.highway',
                elementType: 'labels.icon',
                stylers: [
                    { visibility: 'off' }
                ]
            },{
                featureType: 'water',
                elementType: 'labels.text.stroke',
                stylers: [
                    { lightness: 100 }
                ]
            },{
                featureType: 'water',
                elementType: 'labels.text.fill',
                stylers: [
                    { lightness: -100 }
                ]
            },{
                featureType: 'poi',
                elementType: 'geometry',
                stylers: [
                    { visibility: 'on' },
                    { color: '#f0e4d3' }
                ]
            },{
                featureType: 'road.highway',
                elementType: 'geometry.fill',
                stylers: [
                    { color: '#efe9e4' },
                    { lightness: -25 }
                ]
            }
        ];

        var bishanAMK = new google.maps.LatLng(1.3380368, 103.8128534);

        // Constructor creates a new map - only center and zoom are required.
        map = new google.maps.Map(document.getElementById('map'), {
            center: bishanAMK,
            zoom: 13,
            styles: styles,
            mapTypeControl: false
        });

        // These are the real estate listings that will be shown to the user.
        // Normally we'd have these in a database instead.
/*
        var locations = [
            {
                title: 'Woodlands',
                location: {lat: 1.4369416, lng: 103.7863953},
                address: 'Q30, Woodlands Ave 2, Singapore'
            },
            {
                title: 'Bartley',
                location: {lat: 1.3422592, lng: 103.8802886},
                address: '212 Upper Paya Lebar Road, 534881, Upper Paya Lebar Road'
            },
            {
                title: 'Esplanade',
                location: {lat: 1.2939413, lng: 103.8553744},
                address: '90 Bras Basah Road'
            },
            {
                title: 'Nicoll Highway MRT Station',
                location: {lat: 1.3002399, lng: 103.8635784},
                address: '20 Republic Ave'
            },
            {
                title: 'Kent Ridge MRT Station',
                location: {lat: 1.2924896, lng: 103.7848814},
                address: '301 South Buona Vista Road'
            }

        ];

*/

        var request = {
            location: bishanAMK,
            radius: '5000',
            type: ['library']
        };

        placeService = new google.maps.places.PlacesService(map);
        placeService.nearbySearch(request, callback);

        function callback(results, status) {
            if (status == google.maps.places.PlacesServiceStatus.OK) {
                console.log(results);
                for (var i = 0; i < results.length; i++) {
                    var place = results[i];
                    createMarker(results[i], i);
                }
            }
        }

        var largeInfowindow = new google.maps.InfoWindow();

        // Style the markers a bit. This will be our listing marker icon.
        var defaultIcon = makeMarkerIcon('0091ff');

        // Create a "highlighted location" marker color for when the user
        // mouses over the marker.
        var highlightedIcon = makeMarkerIcon('FFFF24');

        function createMarker(place, index) {
            var placeLoc = place.geometry.location;
            var marker = new google.maps.Marker({
                position: placeLoc,
                title: place.name,
                animation: google.maps.Animation.DROP,
                icon: defaultIcon,
                id: index
            });
            console.log(place.name);

            // Push the marker to our array of markers.
            //markers.push(marker);
            // Create an onclick event to open the large infowindow at each marker.
            marker.addListener('click', function() {
                populateInfoWindow(this, largeInfowindow, place);
            });
            // Two event listeners - one for mouseover, one for mouseout,
            // to change the colors back and forth.
            marker.addListener('mouseover', function() {
                this.setIcon(highlightedIcon);
            });
            marker.addListener('mouseout', function() {
                this.setIcon(defaultIcon);
            });

            marker.setMap(map);
        }
    }

    function populateInfoWindow(marker, infowindow, place) {
        // Check to make sure the infowindow is not already opened on this marker.
        if (infowindow.marker != marker) {
            // Clear the infowindow content to give the streetview time to load.
            infowindow.setContent(marker.title + "<br>" + place.vicinity);
            infowindow.marker = marker;
            // Make sure the marker property is cleared if the infowindow is closed.
            infowindow.addListener('closeclick', function() {
                infowindow.marker = null;
            });

            // Open the infowindow on the correct marker.
            infowindow.open(map, marker);
        }
    }

    function makeMarkerIcon(markerColor) {
        var markerImage = new google.maps.MarkerImage(
            'http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|'+ markerColor +
            '|40|_|%E2%80%A2',
            new google.maps.Size(21, 34),
            new google.maps.Point(0, 0),
            new google.maps.Point(10, 34),
            new google.maps.Size(21,34));
        return markerImage;
    }

    </script>

    <script async defer
        src=
        "https://maps.googleapis.com/maps/api/js?libraries=places,geometry,drawing&key=AIzaSyCSAT41RUuOOAuIAqZKlAYBf2zKzDEtrJs&v&v=3&callback=initMap">
    </script>
</body>
</html>
